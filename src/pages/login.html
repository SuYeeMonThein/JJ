<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Product Manager</title>
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/auth.css">
</head>
<body>
    <div id="app">
        <header class="app-header">
            <div class="container">
                <h1 class="app-title">
                    <a href="../index.html">Product Manager</a>
                </h1>
            </div>
        </header>

        <main class="app-main auth-main">
            <div class="container">
                <div class="auth-container">
                    <div class="auth-card">
                        <h2 class="auth-title">Login to Your Account</h2>
                        <p class="auth-subtitle">Welcome back! Please sign in to continue.</p>

                        <form id="loginForm" class="auth-form" novalidate>
                            <div id="authErrors" class="error-messages" style="display: none;"></div>

                            <div class="form-group">
                                <label for="email" class="form-label">Email Address</label>
                                <input
                                    type="email"
                                    id="email"
                                    name="email"
                                    class="form-input"
                                    placeholder="Enter your email"
                                    required
                                    autocomplete="email"
                                >
                                <div class="field-error" id="emailError"></div>
                            </div>

                            <div class="form-group">
                                <label for="password" class="form-label">Password</label>
                                <div class="password-input-container">
                                    <input
                                        type="password"
                                        id="password"
                                        name="password"
                                        class="form-input"
                                        placeholder="Enter your password"
                                        required
                                        minlength="8"
                                        autocomplete="current-password"
                                    >
                                    <button type="button" class="password-toggle" id="togglePassword" aria-label="Toggle password visibility">
                                        <span class="password-toggle-icon">üëÅÔ∏è</span>
                                    </button>
                                </div>
                                <div class="field-error" id="passwordError"></div>
                            </div>

                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="rememberMe" name="rememberMe">
                                    <span class="checkbox-custom"></span>
                                    Keep me signed in
                                </label>
                            </div>

                            <button type="submit" class="btn btn-primary btn-full" id="loginBtn">
                                Sign In
                            </button>
                        </form>

                        <div class="auth-links">
                            <p>Don't have an account? <a href="signup.html" class="auth-link">Sign up here</a></p>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="app-footer">
            <div class="container">
                <p>&copy; 2025 Product Manager. Secure authentication with Web Crypto API.</p>
            </div>
        </footer>
    </div>

    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <p>Signing you in...</p>
    </div>

    <!-- Toast notifications -->
    <div id="toastContainer" class="toast-container"></div>

    <script src="../js/utils.js"></script>
    <script src="../js/storage.js"></script>
    <script src="../js/prototype-auth.js"></script>
    <script src="../js/prototype-products.js"></script>
    <script>
        // Use Prototype services for demo/prototype (like Figma)
        window.AuthService = window.PrototypeAuthService;
        window.ProductService = window.PrototypeProductService;
    </script>
    <script>
        // Initialize login page
        document.addEventListener('DOMContentLoaded', function() {
            // Check if already logged in
            if (AuthService.isAuthenticated()) {
                window.location.href = '../pages/dashboard.html';
                return;
            }

            // Initialize login form
            const loginForm = document.getElementById('loginForm');
            const togglePassword = document.getElementById('togglePassword');
            const passwordInput = document.getElementById('password');

            // Password visibility toggle
            togglePassword.addEventListener('click', function() {
                const type = passwordInput.type === 'password' ? 'text' : 'password';
                passwordInput.type = type;
                this.querySelector('.password-toggle-icon').textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà';
            });

            // Form submission
            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const email = formData.get('email').trim();
                const password = formData.get('password');
                const rememberMe = formData.get('rememberMe') === 'on';

                try {
                    showLoading(true);
                    clearErrors();

                    const result = await AuthService.login(email, password, rememberMe);
                    
                    if (result.success) {
                        showToast('Login successful! Redirecting...', 'success');
                        setTimeout(() => {
                            window.location.href = '../pages/dashboard.html';
                        }, 1000);
                    } else {
                        showErrors(result.errors);
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    showErrors(['An unexpected error occurred. Please try again.']);
                } finally {
                    showLoading(false);
                }
            });

            function showLoading(show) {
                const overlay = document.getElementById('loadingOverlay');
                const btn = document.getElementById('loginBtn');
                
                overlay.style.display = show ? 'flex' : 'none';
                btn.disabled = show;
                btn.textContent = show ? 'Signing In...' : 'Sign In';
            }

            function clearErrors() {
                document.getElementById('authErrors').style.display = 'none';
                document.querySelectorAll('.field-error').forEach(el => el.textContent = '');
                document.querySelectorAll('.form-input').forEach(el => el.classList.remove('error'));
            }

            function showErrors(errors) {
                const errorContainer = document.getElementById('authErrors');
                errorContainer.innerHTML = errors.map(error => `<p>${error}</p>`).join('');
                errorContainer.style.display = 'block';
            }
        });
    </script>
</body>
</html>